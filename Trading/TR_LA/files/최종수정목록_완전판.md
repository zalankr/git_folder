# 🔧 USLA 트레이딩 시스템 최종 수정 목록 (업데이트)

## 📝 수정해야 할 파일: 총 3개

### 1️⃣ USLA_model.py (2개 함수)
**파일 위치**: `/var/autobot/TR_USLA/USLA_model.py`

#### 수정 함수:
- `calculate_sell_summary()` (약 256-265줄)
- `calculate_buy_summary()` (약 440-449줄)

#### 수정 내용:
- `execution is None` 체크 추가
- 키 이름 변경: `'filled_quantity'` → `'qty'`, `'average_price'` → `'price'`

#### 참고 파일:
- `핵심수정사항_USLA_model.txt`
- `USLA_model_fixed.py`

---

### 2️⃣ USLA_Trading.py (2개 함수)
**파일 위치**: `/var/autobot/TR_USLA/USLA_Trading.py`

#### 수정 함수:
- `Selling()` (약 77-186줄)
- `Buying()` (약 234-348줄)

#### 수정 내용:
- 메시지를 리스트에 누적
- 라운드별로 한 번에 전송

#### 참고 파일:
- `USLA_Trading_함수수정.py`

---

### 3️⃣ KIS_US.py (2개 함수) ⭐ 새로 추가
**파일 위치**: `/var/autobot/TR_USLA/KIS_US.py`

#### 수정 함수:
- `order_sell_US()` 
- `order_buy_US()`

#### 수정 내용:
- **성공 메시지 제거** (주석 처리 또는 삭제)
- **실패/오류 메시지는 유지**

#### 수정 전:
```python
if result.get('rt_cd') == '0':
    # ... order_info 생성 ...
    
    # ❌ 이 줄을 삭제 또는 주석 처리
    KA.SendMessage(f"정규매도 주문: {ticker} {quantity}주 @ ${price:.2f} \n주문번호: {order_info['order_number']}")
    
    return order_info
else:
    # ✅ 실패 메시지는 유지
    KA.SendMessage(f"정규매도 주문실패: {result.get('msg1')}")
```

#### 수정 후:
```python
if result.get('rt_cd') == '0':
    # ... order_info 생성 ...
    
    # ✅ 성공 메시지 제거 (Selling 함수에서 통합 발송)
    # KA.SendMessage(f"정규매도 주문: {ticker} {quantity}주 @ ${price:.2f} \n주문번호: {order_info['order_number']}")
    
    return order_info
else:
    # ✅ 실패 메시지는 유지
    KA.SendMessage(f"정규매도 주문실패: {result.get('msg1')}")
```

#### 참고 파일:
- `KIS_US_함수수정.py`

---

## 📊 메시지 발송 구조 (수정 후)

### 매도/매수 주문 시:

```
[Round 12 시작]

1. KIS_US.order_sell_US() 호출 (5번)
   → 성공: 메시지 발송 안 함 ✅
   → 실패: 즉시 메시지 발송 (개별)

2. Selling() 함수
   → 모든 주문 완료 후 1개 통합 메시지 발송 ✅
   
통합 메시지:
┌─────────────────────────────────┐
│ 12/25회 매도주문                  │
│ ✅ TQQQ 3주 @$111.96 (분할1)    │
│ ✅ TQQQ 3주 @$111.68 (분할2)    │
│ ❌ TQQQ 3주 @$111.40 - 실패     │
│ ✅ EDC 4주 @$54.00 (분할1)      │
│ 매도 완료: 3/4 성공              │
└─────────────────────────────────┘
```

### 수정 전 vs 수정 후:

| 상황 | 수정 전 | 수정 후 |
|------|---------|---------|
| 5분할 주문 성공 | 10개 메시지 | 1개 메시지 |
| - KIS_US 성공 메시지 | 5개 | 0개 ✅ |
| - Selling 개별 메시지 | 5개 | 0개 ✅ |
| - Selling 통합 메시지 | 0개 | 1개 ✅ |
| **총 메시지** | **10개** | **1개** |

---

## 🚀 빠른 적용 순서

### Step 1: 백업
```bash
cd /var/autobot/TR_USLA
cp USLA_model.py USLA_model.py.backup
cp USLA_Trading.py USLA_Trading.py.backup
cp KIS_US.py KIS_US.py.backup
```

### Step 2: KIS_US.py 수정 ⭐ 가장 먼저!
```bash
vim KIS_US.py

# order_sell_US 함수 찾기
/def order_sell_US

# 성공 메시지 줄 찾아서 주석 처리:
# KA.SendMessage(f"정규매도 주문: {ticker}...")

# order_buy_US 함수에서도 동일하게 수정
/def order_buy_US

# 성공 메시지 줄 찾아서 주석 처리:
# KA.SendMessage(f"정규매수 주문: {ticker}...")
```

### Step 3: USLA_model.py 수정
```bash
vim USLA_model.py

# 핵심수정사항_USLA_model.txt 참고
# calculate_sell_summary, calculate_buy_summary 수정
```

### Step 4: USLA_Trading.py 수정
```bash
vim USLA_Trading.py

# USLA_Trading_함수수정.py 참고
# Selling, Buying 함수 수정
```

### Step 5: 문법 체크
```bash
python3 -m py_compile KIS_US.py
python3 -m py_compile USLA_model.py
python3 -m py_compile USLA_Trading.py
```

---

## ✅ 수정 체크리스트

- [ ] **KIS_US.py** (2개 함수)
  - [ ] `order_sell_US()`: 성공 메시지 주석 처리
  - [ ] `order_buy_US()`: 성공 메시지 주석 처리
  - [ ] 실패/오류 메시지는 그대로 유지

- [ ] **USLA_model.py** (2개 함수)
  - [ ] `calculate_sell_summary()`: None 체크 + 키 수정
  - [ ] `calculate_buy_summary()`: None 체크 + 키 수정

- [ ] **USLA_Trading.py** (2개 함수)
  - [ ] `Selling()`: 메시지 통합
  - [ ] `Buying()`: 메시지 통합

- [ ] **백업 완료**
  - [ ] USLA_model.py.backup
  - [ ] USLA_Trading.py.backup
  - [ ] KIS_US.py.backup

- [ ] **문법 체크 통과**
  - [ ] KIS_US.py
  - [ ] USLA_model.py
  - [ ] USLA_Trading.py

---

## 🎯 예상 결과

### 메시지 예시 (수정 후):

```
12/25회 매수주문
✅ TQQQ 3주 @$111.96 (분할1)
✅ TQQQ 3주 @$111.68 (분할2)
❌ TQQQ 3주 @$111.40 - 주문가능금액 초과 (분할3)
✅ EDC 4주 @$54.00 (분할1)
매수 완료: 3/4 성공

📥 매수 체결 요약:
주문: 3건 (완전체결:3, 부분:0, 미체결:0)
수량: 13/13
매수금액: $551.88 (수수료 포함)

USD 변화: -$551.88 (이전: $2222.50 → 현재: $1670.62)
```

### 메시지 수 비교:

| 항목 | 수정 전 | 수정 후 | 감소율 |
|------|---------|---------|--------|
| 라운드당 메시지 | 15-20개 | 2-3개 | **85%↓** |
| 주문 메시지 | 10개 | 1개 | **90%↓** |
| 체결 메시지 | 2개 | 2개 | 유지 |

---

## 💡 왜 KIS_US.py도 수정해야 하나?

### 문제:
```
[현재 구조]
order_sell_US: "정규매도 주문: TQQQ 3주 @ $111.96" 
→ Selling: "✅ TQQQ 3주 @$111.96 (분할1)"

= 1개 주문당 2개 메시지! 😱
```

### 해결:
```
[수정 후]
order_sell_US: 메시지 없음
→ Selling: "✅ TQQQ 3주 @$111.96 (분할1)"

= 1개 주문당 1개 메시지! ✅
```

### 실패 메시지는 왜 유지?
- **즉시 알아야 하는 정보**이므로 개별 발송 유지
- 성공 메시지만 통합해도 90% 감소 효과

---

## 📞 문제 발생 시

### 백업 복구:
```bash
cd /var/autobot/TR_USLA
cp USLA_model.py.backup USLA_model.py
cp USLA_Trading.py.backup USLA_Trading.py
cp KIS_US.py.backup KIS_US.py
```

### 로그 확인:
```bash
tail -f /var/autobot/TR_USLA/usla_trading.log
```

---

## 🎯 핵심 요약

**3개 파일, 6개 함수 수정:**

1. **KIS_US.py** (2개 함수) ⭐ 필수!
   - 성공 메시지 제거

2. **USLA_model.py** (2개 함수)
   - None 체크 + 키 수정

3. **USLA_Trading.py** (2개 함수)
   - 메시지 통합

**예상 소요 시간**: 20-30분  
**메시지 감소 효과**: 85-90%  
**난이도**: 중하 (텍스트 편집 가능하면 OK)
